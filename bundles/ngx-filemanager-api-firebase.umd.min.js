!function(e,r){"object"==typeof exports&&"undefined"!=typeof module?r(exports,require("verror"),require("jsonwebtoken"),require("path"),require("formidable"),require("fs")):"function"==typeof define&&define.amd?define("ngx-filemanager-api-firebase",["exports","verror","jsonwebtoken","path","formidable","fs"],r):r((e=e||self)["ngx-filemanager-api-firebase"]={},e.verror,e.jwt,e.path,e.formidable,e.fs)}(this,(function(e,r,t,n,s,i){"use strict";
/*! *****************************************************************************
    Copyright (c) Microsoft Corporation.

    Permission to use, copy, modify, and/or distribute this software for any
    purpose with or without fee is hereby granted.

    THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH
    REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY
    AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,
    INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM
    LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR
    OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
    PERFORMANCE OF THIS SOFTWARE.
    ***************************************************************************** */function o(e,r,t,n){return new(t||(t=Promise))((function(s,i){function o(e){try{a(n.next(e))}catch(e){i(e)}}function u(e){try{a(n.throw(e))}catch(e){i(e)}}function a(e){var r;e.done?s(e.value):(r=e.value,r instanceof t?r:new t((function(e){e(r)}))).then(o,u)}a((n=n.apply(e,r||[])).next())}))}function u(e,r){var t,n,s,i,o={label:0,sent:function(){if(1&s[0])throw s[1];return s[1]},trys:[],ops:[]};return i={next:u(0),throw:u(1),return:u(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function u(i){return function(u){return function(i){if(t)throw new TypeError("Generator is already executing.");for(;o;)try{if(t=1,n&&(s=2&i[0]?n.return:i[0]?n.throw||((s=n.return)&&s.call(n),0):n.next)&&!(s=s.call(n,i[1])).done)return s;switch(n=0,s&&(i=[2&i[0],s.value]),i[0]){case 0:case 1:s=i;break;case 4:return o.label++,{value:i[1],done:!1};case 5:o.label++,n=i[1],i=[0];continue;case 7:i=o.ops.pop(),o.trys.pop();continue;default:if(!(s=o.trys,(s=s.length>0&&s[s.length-1])||6!==i[0]&&2!==i[0])){o=0;continue}if(3===i[0]&&(!s||i[1]>s[0]&&i[1]<s[3])){o.label=i[1];break}if(6===i[0]&&o.label<s[1]){o.label=s[1],s=i;break}if(s&&o.label<s[2]){o.label=s[2],o.ops.push(i);break}s[2]&&o.ops.pop(),o.trys.pop();continue}i=r.call(e,o)}catch(e){i=[6,e],n=0}finally{t=s=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}([i,u])}}}function a(e,r){var t="function"==typeof Symbol&&e[Symbol.iterator];if(!t)return e;var n,s,i=t.call(e),o=[];try{for(;(void 0===r||r-- >0)&&!(n=i.next()).done;)o.push(n.value)}catch(e){s={error:e}}finally{try{n&&!n.done&&(t=i.return)&&t.call(i)}finally{if(s)throw s.error}}return o}function c(){for(var e=[],r=0;r<arguments.length;r++)e=e.concat(a(arguments[r]));return e}var l=require("cors");function h(e,r,t){if("OPTIONS"===e.method)return console.log("Recieved OPTIONS request sending OK"),void r.status(200).send("Options are OK\n");t()}function f(e,r,t){if("POST"!==e.method){var n="Only POST requests are supported\n";return console.warn(n),void r.status(400).send(n)}t()}function d(e){return function(r,t,n){if(!r.body[e]){var s='Request is missing property in req.body: "'+e+'" \n';return console.warn(s),void t.status(400).send(s)}n()}}function v(e){return function(r,t,n){if(!r.query[e]){var s='Request is missing property in req.params: "'+e+'" \n';return console.warn(s),void t.status(400).send(s)}n()}}function p(e){return o(this,void 0,void 0,(function(){var r,t,n;return u(this,(function(s){switch(s.label){case 0:if(t=e.headers.authorization,n=e.cookies,t)r=e.headers.authorization;else{if(!n)throw new Error("Request Header doesn't contain a valid authorization bearer");r=e.cookies.__session}return[4,m(r)];case 1:return[2,s.sent()]}}))}))}function m(e){return o(this,void 0,void 0,(function(){return u(this,(function(r){try{return[2,t.decode(e,{json:!0})]}catch(e){throw new Error("Error decoding JWT"+e.message)}return[2]}))}))}var w={blankPermissionsObj:function(){return{others:"read/write",readers:[],writers:[]}},blankUserClaim:function(){return{groups:[]}}};function y(e,r,t){return o(this,void 0,void 0,(function(){var n,s,i,o,c;return u(this,(function(u){switch(u.label){case 0:return u.trys.push([0,2,,7]),(n={metadata:{}}).metadata[r]=t,[4,e.setMetadata(n)];case 1:return[2,u.sent()[0]];case 2:s=u.sent(),i=void 0,u.label=3;case 3:return u.trys.push([3,5,,6]),[4,e.exists()];case 4:return c=a.apply(void 0,[u.sent(),1]),i=c[0],[3,6];case 5:return o=u.sent(),console.error("storage-helper: SetMetaProperty() error getting file.exists",o),[3,6];case 6:throw console.error("storage-helper: SetMetaProperty() error setting meta",{fileExists:i,filePath:e.name,newValueString:t}),new Error(s);case 7:return[2]}}))}))}function b(e,t){return o(this,void 0,void 0,(function(){var n,s,i,o,c,l;return u(this,(function(u){switch(u.label){case 0:return u.trys.push([0,2,,7]),[4,e.getMetadata()];case 1:return n=a.apply(void 0,[u.sent(),1]),s=n[0],i=s.metadata||{},[2,i[t]||null];case 2:o=u.sent(),u.label=3;case 3:return u.trys.push([3,5,,6]),[4,e.exists()];case 4:return c=a.apply(void 0,[u.sent(),1]),c[0],[3,6];case 5:return l=u.sent(),console.error(l),[3,6];case 6:throw console.error("storage-helper: GetMetaProperty() error getting meta",{}),new r.VError(o);case 7:return[2]}}))}))}var g={GetMetaPropertyObj:function(e,t){return o(this,void 0,void 0,(function(){var n,s;return u(this,(function(i){switch(i.label){case 0:return i.trys.push([0,2,,3]),[4,b(e,t)];case 1:return n=i.sent(),[2,JSON.parse(n)];case 2:throw s=i.sent(),console.error('could not convert the meta property "'+t+'" to a JSON object',s,{newValueString:n}),new r.VError(s+" error in JSON processing: "+n);case 3:return[2]}}))}))},SetMetaPropertyObj:function(e,r,t){return o(this,void 0,void 0,(function(){var n;return u(this,(function(s){try{return n=JSON.stringify(t),[2,y(e,r,n)]}catch(e){throw new Error(e)}return[2]}))}))},GetMetaPropertyString:b,SetMetaPropertyString:y};function P(e,r,t){var n=function(e,r){switch(r){case"read":return function(e){return null==e||"read"===e||"read/write"===e}(e);case"write":return function(e){return"read/write"===e}(e)}}(e.others,t);if(n)return!0;if(!!!r)return!1;if(r.userIsSudo)return!0;var s=c(r.groups,[r.user_id]);return!!E("read"===t?e.readers:e.writers,s)}function E(e,r){if(!r||!r.length)return!1;var t=new Set(r);return!!e.find((function(e){return t.has(e)}))}var S={RetrieveFilePermissions:function(e){return o(this,void 0,void 0,(function(){var r,t;return u(this,(function(n){switch(n.label){case 0:return[4,g.GetMetaPropertyObj(e,"permissions")];case 1:return r=n.sent(),t=w.blankPermissionsObj(),[2,Object.assign(Object.assign({},t),r||{})]}}))}))},RetrieveCustomClaims:function(e){return o(this,void 0,void 0,(function(){var r,t;return u(this,(function(n){switch(n.label){case 0:return n.trys.push([0,2,,3]),[4,p(e)];case 1:return r=n.sent(),[3,3];case 2:return n.sent(),console.log("No bearer token found on request, no permissions for user"),[2,w.blankUserClaim()];case 3:return(t=r).groups||(t.groups=[]),[2,t]}}))}))},TryCheckHasAnyPermissions:function(e){if(!e.groups.length&&!e.userIsSudo)throw new Error("No user permissions found, cannot change permissions")},TryCheckFileAccess:P,IsPartOfArray:E,CheckCanEditPermissions:function(e,t,n){var s=P(e,n,"write"),i=P(t,n,"write");if(!s)throw new r.VError("Cannot edit permissions here");if(!i)throw new r.VError("Cannot change permissions, so you wont be able to change back")}};var F={factory:w,commands:{UpdateFilePermissions:function(e,r){return o(this,void 0,void 0,(function(){return u(this,(function(t){return[2,g.SetMetaPropertyObj(e,"permissions",r)]}))}))}},queries:S};function k(e){return!(!e||!e.length)&&e.startsWith("/")}function x(e){return!(!e||!e.length)&&e.endsWith("/")}function C(e){return e?x(e)?e:e+"/":"/"}function O(e){return k(e)?e.slice(1):e}function G(e){return e?k(e)?e:"/"+e:"/"}function V(e){return x(e)?e.slice(0,-1):e}function j(e){return O(C(e))}function q(e,r){return r.slice(e.length)}function T(e){return x(G(e))}function R(e){return e.split("/").pop()}var H={HasPrefixSlash:k,HasTrailingSlash:x,EnsureTrailingSlash:C,EnsureNoPrefixSlash:O,EnsurePrefixSlash:G,EnsureNoTrailingSlash:V,EnsureAbsolutePathFile:function(e){return G(V(e))},EnsureAbsolutePathDir:function(e){return G(C(e))},EnsureGoogleStoragePathDir:j,EnsureGoogleStoragePathFile:function(e){return O(V(e))},GetRelativePath:q,IsCurrentPath:function(e,r){return!q(e,r)},IsCurrentPathFile:function(e,r){return q(e,r).split("/").length<2},IsObjNameDir:T,IsObjNameFile:function(e){return!T(e)},GetSubDirectory:function(e,r){return q(e,r).split("/").shift()},GetParentDir:function(e){var r=G(e);return j(n.dirname(r))},GetFileNameWithExtension:R,GetFileNameWithoutExtension:function(e){var r=R(e).split(".");return r.pop(),r.join(".")},GetPathUpToLastBracket:function(e){var r=e.split("/");r.pop();var t=r.join("/"),s=e.slice(t.length),i=s.split("(");i.pop();var o=i.join("(");if(s.includes("("))return n.join(t,o+"(");var u=e.split(".");return u.length<2?e:(u.pop(),u.join("."))},Add2ToPath:function(e){var r=e.split("."),t=r.pop();return r.join(".")+" (2)."+t},Add2ToPathDir:function(e){return C(V(e)+" (2)")}};function N(e){var r=e.name,t=H.EnsurePrefixSlash(r);return{ref:e,name:n.basename(t),fullPath:t,isDir:H.HasTrailingSlash(t)}}function D(e){return o(this,void 0,void 0,(function(){var t,n,s,i,o,c,l,h,f;return u(this,(function(u){switch(u.label){case 0:if((t={}).name=e.name,e.isDir?(t.type="dir",t.fullPath=H.EnsureAbsolutePathDir(e.fullPath)):(t.type="file",t.fullPath=H.EnsureAbsolutePathFile(e.fullPath)),e.isPhantomFolder)return t.permissions=F.factory.blankPermissionsObj(),t.isPhantomFolder=!0,[2,t];u.label=1;case 1:return u.trys.push([1,6,,7]),[4,e.ref.exists()];case 2:if(n=a.apply(void 0,[u.sent(),1]),!n[0])throw new Error("File not found: "+t.fullPath);return[4,e.ref.acl.get()];case 3:return s=a.apply(void 0,[u.sent(),1]),i=s[0],t.rightsFirebase=i,[4,e.ref.getMetadata()];case 4:return o=u.sent(),c=o[0],l=c.metadata||{},[4,F.queries.RetrieveFilePermissions(e.ref)];case 5:return h=u.sent(),t.permissions=h,t.size=c.size,t.date=c.updated,t.metaData=l,[2,t];case 6:throw f=u.sent(),new r.VError(f);case 7:return[2]}}))}))}function A(e){return o(this,void 0,void 0,(function(){return u(this,(function(r){return[2,new Promise((function(r,t){var n;e.on("readable",(function(e){var r=e.read().toString();n+=r,console.log("stream data "+r)})),e.on("end",(function(e){r(n)})),e.on("error",(function(e){var r="StreamToPromise(stream: Readable), Error reading stream: "+e.message;console.error(r,{err:e}),t(r)}))}))]}))}))}function M(e){return e.reduce((function(e,r){return r.error&&(e.error+=" | "+r.error,e.success=!1),e}),{error:"",success:!0})}function W(){return{delimiter:"/",includeTrailingDelimiter:!0,autoPaginate:!1}}function B(e){return{delimiter:"/",includeTrailingDelimiter:!0,directory:e,autoPaginate:!1}}function L(e,r){return o(this,void 0,void 0,(function(){return u(this,(function(t){return[2,new Promise((function(t,n){e.getFiles(r,(function(e,r,s,i){if(e)n(e);else{var o=i.prefixes||[];t({files:r||[],prefixes:o})}}))}))]}))}))}function I(e,t){return o(this,void 0,void 0,(function(){var s,i,o,a,l,h,f,d,v;return u(this,(function(u){switch(u.label){case 0:s=H.EnsureGoogleStoragePathDir(t),i="/"===s||""?{delimiter:"/",includeTrailingDelimiter:!0,autoPaginate:!1}:B(s),u.label=1;case 1:return u.trys.push([1,3,,4]),[4,L(e,i)];case 2:return o=u.sent(),a=o.files.map((function(e){return N(e)})),l=new Set(a.map((function(e){return e.ref.name}))),h=o.prefixes.filter((function(e){return!l.has(e)})),f=h.map((function(e){return r=e,t=H.EnsureAbsolutePathDir(r),{ref:null,name:n.basename(t),fullPath:t,isDir:!0,isPhantomFolder:!0};var r,t})),d=c(a,f),[2,d.filter((function(e){return H.EnsureGoogleStoragePathDir(e.fullPath)!==s}))];case 3:throw v=u.sent(),new r.VError(v);case 4:return[2]}}))}))}var U={GetListWithoutPermissions:function(e,t){return o(this,void 0,void 0,(function(){var n,s;return u(this,(function(i){switch(i.label){case 0:return i.trys.push([0,3,,4]),[4,I(e,t)];case 1:return n=i.sent(),[4,Promise.all(n.map((function(e){return D(e)})))];case 2:return[2,i.sent()];case 3:throw s=i.sent(),new r.VError(s);case 4:return[2]}}))}))},GetAllChildrenWithPrefix:function(e,t){return o(this,void 0,void 0,(function(){var n,s,i,o;return u(this,(function(u){switch(u.label){case 0:n=H.EnsureNoPrefixSlash(t),(s={}).prefix=n,u.label=1;case 1:return u.trys.push([1,3,,4]),[4,e.getFiles(s)];case 2:return i=u.sent(),[2,i[0]];case 3:throw o=u.sent(),new r.VError(o);case 4:return[2]}}))}))},MakeOptionsListRoot:W,MakeOptionsList:B,TryRenameFile:function(e,t,s){return o(this,void 0,void 0,(function(){var i,o,c,l,h,f,d,v;return u(this,(function(u){switch(u.label){case 0:return u.trys.push([0,2,,4]),i=e.name,o=i.slice(t.length),c=n.join(s,o),l=H.EnsureNoPrefixSlash(c),console.log('- renaming "'+i+'" -> "'+l+'"'),[4,e.move(l)];case 1:return h=a.apply(void 0,[u.sent(),1]),h[0],[2,{error:"",success:!0}];case 2:return f=u.sent(),[4,e.exists()];case 3:throw d=a.apply(void 0,[u.sent(),1]),v=d[0],console.error("storage-helper: TryCopyFile() error renaming file",{fileExists:v,fileName:e.name,oldPrefix:t,newPrefix:s}),new r.VError(f);case 4:return[2]}}))}))},TryCopyFile:function(e,t,s){return o(this,void 0,void 0,(function(){var i,o,c,l,h,f,d;return u(this,(function(u){switch(u.label){case 0:return u.trys.push([0,2,,4]),i=e.name,o=i.slice(t.length),c=n.join(s,o),l=H.EnsureNoPrefixSlash(c),console.log('- copying "'+i+'" -> "'+l+'"'),[4,e.copy(l)];case 1:return[2,u.sent()[1]];case 2:return h=u.sent(),[4,e.exists()];case 3:throw f=a.apply(void 0,[u.sent(),1]),d=f[0],console.error("storage-helper: TryCopyFile() error copying file",{fileExists:d}),new r.VError(h);case 4:return[2]}}))}))},TryCheckWritePermission:function e(r,t,n){return o(this,void 0,void 0,(function(){var s,i,o,c,l;return u(this,(function(u){switch(u.label){case 0:return u.trys.push([0,3,,4]),s=H.GetParentDir(t),""===s?[2]:[4,(i=r.file(s)).exists()];case 1:return o=a.apply(void 0,[u.sent(),1]),o[0]?[4,F.queries.RetrieveFilePermissions(i)]:[2,e(r,s,n)];case 2:if(c=u.sent(),!F.queries.TryCheckFileAccess(c,n,"write"))throw new Error("Permission denied creating item in directory:"+s);return[3,4];case 3:throw l=u.sent(),new Error(l);case 4:return[2]}}))}))}};function J(e,t){return o(this,void 0,void 0,(function(){var n,s,i;return u(this,(function(c){switch(c.label){case 0:return c.trys.push([0,3,,4]),[4,U.GetAllChildrenWithPrefix(e,t)];case 1:return n=c.sent(),[4,Promise.all(n.map((function(e){return function(e){return o(this,void 0,void 0,(function(){var t;return u(this,(function(n){switch(n.label){case 0:return n.trys.push([0,4,,5]),[4,e.exists()];case 1:return a.apply(void 0,[n.sent(),1])[0]?(console.log("- deleting file: ",e.name),[4,e.delete()]):[3,3];case 2:return n.sent(),[2,!0];case 3:return[2,!1];case 4:throw t=n.sent(),new r.VError(t);case 5:return[2]}}))}))}(e)})))];case 2:return s=c.sent(),[2,s.reduce((function(e,r){return e&&r}),!0)];case 3:throw i=c.sent(),new r.VError(i);case 4:return[2]}}))}))}var _=require("moment");function z(e){return o(this,void 0,void 0,(function(){var t,n,s,i;return u(this,(function(o){switch(o.label){case 0:return o.trys.push([0,2,,3]),t=_().add(5,"minutes").toDate(),n={expires:t,action:"read"},[4,e.getSignedUrl(n)];case 1:return s=o.sent(),[2,s.shift()];case 2:throw i=o.sent(),new r.VError(i);case 3:return[2]}}))}))}function K(e,r){return o(this,void 0,void 0,(function(){var t,n,s,i;return u(this,(function(o){switch(o.label){case 0:t=H.EnsureGoogleStoragePathDir(r),n=e.file(t),s={success:!0},o.label=1;case 1:return o.trys.push([1,4,,5]),[4,n.save("")];case 2:return o.sent(),i=F.factory.blankPermissionsObj(),[4,F.commands.UpdateFilePermissions(n,i)];case 3:return o.sent(),[3,5];case 4:return o.sent(),s.success=!1,[3,5];case 5:return[2,s]}}))}))}function X(e,r){return o(this,void 0,void 0,(function(){var t,n,s,i,o,a;return u(this,(function(u){switch(u.label){case 0:return t=H.GetParentDir(r.name),[4,U.GetListWithoutPermissions(e,t)];case 1:return n=u.sent(),!n||!n.length?[2,r]:(s=n.map((function(e){return H.EnsureGoogleStoragePathDir(e.fullPath)})),i=H.EnsureGoogleStoragePathDir(r.name),o=s.some((function(e){return e===i})),o?(a=H.Add2ToPathDir(i),[2,e.file(a)]):[2,r])}}))}))}function Q(e,r,t){var n=Object.assign(Object.assign({},F.factory.blankPermissionsObj()),e);return"READER"===r&&(n.readers.includes(t)||n.readers.push(t)),"WRITER"===r&&(n.writers.includes(t)||n.writers.push(t)),n}function Y(e,r,t,n){return o(this,void 0,void 0,(function(){var s,i,o;return u(this,(function(u){switch(u.label){case 0:return u.trys.push([0,3,,4]),[4,F.queries.RetrieveFilePermissions(e)];case 1:return s=u.sent(),i=Q(s,r,t),F.queries.CheckCanEditPermissions(s,i,n),[4,F.commands.UpdateFilePermissions(e,i)];case 2:return[2,u.sent()];case 3:throw o=u.sent(),new Error(o);case 4:return[2]}}))}))}function Z(e,r,t){return o(this,void 0,void 0,(function(){var n;return u(this,(function(s){return n={contentType:r},console.log("uploadFile: SaveBufferToPath",{mimetype:r,path:e.name}),[2,e.save(t,n)]}))}))}function $(e,r){return o(this,void 0,void 0,(function(){var t,n,s,i,o;return u(this,(function(u){switch(u.label){case 0:return t=H.GetParentDir(r.name),[4,U.GetListWithoutPermissions(e,t)];case 1:return(n=u.sent())&&n.length?(s=n.map((function(e){return e.fullPath})).sort(),i=s.shift(),o=H.Add2ToPath(i),[2,e.file(o)]):[2,r]}}))}))}function ee(e,r,t){return o(this,void 0,void 0,(function(){var t;return u(this,(function(n){switch(n.label){case 0:return n.trys.push([0,2,,3]),[4,F.commands.UpdateFilePermissions(e,r)];case 1:return[2,n.sent()];case 2:throw t=n.sent(),new Error(t);case 3:return[2]}}))}))}var re={GetList:function(e,t,n,s){return o(this,void 0,void 0,(function(){var i,o;return u(this,(function(u){switch(u.label){case 0:return u.trys.push([0,2,,3]),[4,U.GetListWithoutPermissions(e,t)];case 1:return i=u.sent(),s?[2,i]:[2,i.filter((function(e){return F.queries.TryCheckFileAccess(e.permissions,n,"read")}))];case 2:throw o=u.sent(),new r.VError(o);case 3:return[2]}}))}))},RenameFile:function(e,t,n,s){return o(this,void 0,void 0,(function(){var s,i,o,c,l,h;return u(this,(function(u){switch(u.label){case 0:return u.trys.push([0,6,,7]),s=H.EnsureNoPrefixSlash(t),i=H.EnsureNoPrefixSlash(n),[4,(o=e.file(s)).exists()];case 1:if(c=a.apply(void 0,[u.sent(),1]),!c[0])throw new Error('\nitem: "'+o.name+'" does not exist\nbucket: "'+e.name+'"\n\ninputSrc: "'+t+'",\ninputDest: "'+n+'",\n\nparsedSrc: "'+s+'",\nparsedDest: "'+i+'",\n');return!t.endsWith("/")?[4,U.TryRenameFile(o,s,i)]:[3,3];case 2:return[2,u.sent()];case 3:return[4,U.GetAllChildrenWithPrefix(e,s)];case 4:return l=u.sent(),[4,Promise.all(l.map((function(e){return U.TryRenameFile(e,s,i)})))];case 5:return[2,M(u.sent())];case 6:throw h=u.sent(),new r.VError(h);case 7:return[2]}}))}))},MoveFiles:function(e,t,s,i){return o(this,void 0,void 0,(function(){var i,a,c;return u(this,(function(l){switch(l.label){case 0:return l.trys.push([0,2,,3]),i=H.EnsureGoogleStoragePathDir(s),[4,Promise.all(t.map((function(t){return function(e,t,s){return o(this,void 0,void 0,(function(){var i,o,a;return u(this,(function(u){switch(u.label){case 0:return u.trys.push([0,3,,4]),i=H.EnsureNoPrefixSlash(n.dirname(t)),[4,U.GetAllChildrenWithPrefix(e,t)];case 1:return o=u.sent(),[4,Promise.all(o.map((function(e){return U.TryRenameFile(e,i,s)})))];case 2:return[2,u.sent()];case 3:throw a=u.sent(),new r.VError(a);case 4:return[2]}}))}))}(e,t,i)})))];case 1:return a=l.sent(),[2,M(a.reduce((function(e,r){return e.concat(r)}),[]))];case 2:throw c=l.sent(),new r.VError(c);case 3:return[2]}}))}))},CopyFiles:function(e,t,s,i){return o(this,void 0,void 0,(function(){var i,a,c,l;return u(this,(function(h){switch(h.label){case 0:return h.trys.push([0,2,,3]),i=H.EnsureGoogleStoragePathDir(s),[4,Promise.all(t.map((function(t){return function(e,t,s){return o(this,void 0,void 0,(function(){var i,o,a;return u(this,(function(u){switch(u.label){case 0:return u.trys.push([0,3,,4]),i=H.EnsureNoPrefixSlash(n.dirname(t)),[4,U.GetAllChildrenWithPrefix(e,t)];case 1:return o=u.sent(),[4,Promise.all(o.map((function(e){return U.TryCopyFile(e,i,s)})))];case 2:return[2,u.sent()];case 3:throw a=u.sent(),new r.VError(a);case 4:return[2]}}))}))}(e,t,i)})))];case 1:return a=h.sent(),c=a.reduce((function(e,r){return e.concat(r)}),[]),f=c.find((function(e){return 204!==e.statusCode})),[2,{success:!f,error:f?"error: "+JSON.stringify(f.body):null}];case 2:throw l=h.sent(),new r.VError(l);case 3:return[2]}var f}))}))},RemoveFiles:function(e,t,n){return o(this,void 0,void 0,(function(){var n,s,i,o;return u(this,(function(u){switch(u.label){case 0:return u.trys.push([0,2,,3]),n=t.map((function(e){return H.EnsureNoPrefixSlash(e)})),[4,Promise.all(n.map((function(r){return J(e,r)})))];case 1:return s=u.sent(),i=s.reduce((function(e,r){return e&&r}),!0),[2,{success:i}];case 2:throw o=u.sent(),new r.VError(o);case 3:return[2]}}))}))},EditFile:function(e,r,t,n){return o(this,void 0,void 0,(function(){var n;return u(this,(function(s){switch(s.label){case 0:n={success:!0},s.label=1;case 1:return s.trys.push([1,3,,4]),[4,e.file(r).save(t)];case 2:return s.sent(),[3,4];case 3:return s.sent(),n.success=!1,[3,4];case 4:return[2,n]}}))}))},GetFileContent:function(e,t,n){return o(this,void 0,void 0,(function(){var n,s;return u(this,(function(i){switch(i.label){case 0:return i.trys.push([0,3,,4]),[4,e.file(t).get()];case 1:return n=i.sent(),[4,A(n[0].createReadStream())];case 2:return[2,i.sent()];case 3:throw s=i.sent(),new r.VError(s);case 4:return[2]}}))}))},GetSingle:function(e,t,n){return o(this,void 0,void 0,(function(){var n,s,i,o,a;return u(this,(function(u){switch(u.label){case 0:return u.trys.push([0,3,,4]),n=H.EnsureNoPrefixSlash(t),s=e.file(n),[4,D(N(s))];case 1:return i=u.sent(),o=i,[4,z(s)];case 2:return o.downloadUrl=u.sent(),[2,i];case 3:throw a=u.sent(),new r.VError(a);case 4:return[2]}}))}))},CreateFolder:function(e,r,t,n,s){return o(this,void 0,void 0,(function(){var i,o,a,c;return u(this,(function(u){switch(u.label){case 0:return u.trys.push([0,6,,7]),i=H.EnsureGoogleStoragePathDir(r),o=e.file(i),a=void 0,n?[3,2]:[4,X(e,o)];case 1:return a=u.sent(),[3,3];case 2:a=o,u.label=3;case 3:return s?[3,5]:[4,U.TryCheckWritePermission(e,a.name,t)];case 4:u.sent(),u.label=5;case 5:return[2,K(e,a.name)];case 6:throw c=u.sent(),new Error(c);case 7:return[2]}}))}))},ChangePermissions:function(e,t,n,s,i,a){return o(this,void 0,void 0,(function(){var c;return u(this,(function(l){switch(l.label){case 0:return l.trys.push([0,2,,3]),[4,Promise.all(t.map((function(t){return function(e,t,n,s,i,a){return o(this,void 0,void 0,(function(){var o,c,l;return u(this,(function(u){switch(u.label){case 0:if(!i)return[3,6];u.label=1;case 1:return u.trys.push([1,4,,5]),[4,U.GetAllChildrenWithPrefix(e,t)];case 2:return o=u.sent(),[4,Promise.all(o.map((function(e){return Y(e,n,s,a)})))];case 3:return[2,u.sent()];case 4:throw c=u.sent(),new r.VError(c);case 5:return[3,9];case 6:return u.trys.push([6,8,,9]),[4,Y(e.file(t),n,s,a)];case 7:return[2,[u.sent()]];case 8:throw l=u.sent(),new r.VError(l);case 9:return[2]}}))}))}(e,t,n,s,i,a)})))];case 1:return[2,{success:l.sent()}];case 2:throw c=l.sent(),new Error(c.message);case 3:return[2]}}))}))},ChangePermissionsObject:function(e,t,n,s,i){return o(this,void 0,void 0,(function(){var i;return u(this,(function(a){switch(a.label){case 0:return a.trys.push([0,2,,3]),[4,Promise.all(t.map((function(t){return function(e,t,n,s,i){return o(this,void 0,void 0,(function(){var i,o,a;return u(this,(function(u){switch(u.label){case 0:if(!s)return[3,6];u.label=1;case 1:return u.trys.push([1,4,,5]),[4,U.GetAllChildrenWithPrefix(e,t)];case 2:return i=u.sent(),[4,Promise.all(i.map((function(e){return ee(e,n)})))];case 3:return[2,u.sent()];case 4:throw o=u.sent(),new r.VError(o);case 5:return[3,9];case 6:return u.trys.push([6,8,,9]),[4,ee(e.file(t),n)];case 7:return[2,[u.sent()]];case 8:throw a=u.sent(),new r.VError(a);case 9:return[2]}}))}))}(e,t,n,s)})))];case 1:return[2,{success:a.sent()}];case 2:throw i=a.sent(),new Error(i.message);case 3:return[2]}}))}))},UploadFile:function(e,r,t,s,i,c){return o(this,void 0,void 0,(function(){var o,c,l,h,f,d;return u(this,(function(u){switch(u.label){case 0:o=n.join(r,t),c=H.EnsureGoogleStoragePathFile(o),l=e.file(c),u.label=1;case 1:return u.trys.push([1,7,,8]),h=void 0,[4,l.exists()];case 2:return f=a.apply(void 0,[u.sent(),1]),f[0]?[4,$(e,l)]:[3,4];case 3:return h=u.sent(),[3,5];case 4:h=l,u.label=5;case 5:return[4,Z(h,s,i)];case 6:return u.sent(),[3,8];case 7:throw d=u.sent(),new Error("UploadFile: "+d);case 8:return[2]}}))}))}};function te(e,r){return o(this,void 0,void 0,(function(){return u(this,(function(t){if(!e[r])throw new Error("Request is missing property in req.body: '"+r+"'");return[2]}))}))}var ne=function(){function e(e){this.storage=e}return e.prototype.getBucket=function(e){return o(this,void 0,void 0,(function(){var r,t;return u(this,(function(n){switch(n.label){case 0:if(!e)throw new Error("Request is missing property in req.body: 'bucketname'");n.label=1;case 1:return n.trys.push([1,3,,4]),[4,(r=this.storage.bucket(e)).exists()];case 2:if(!n.sent().shift())throw new Error('bucket: "'+e+"\" doesn't exist, please create it first");return[2,r];case 3:throw t=n.sent(),new Error("Error retrieving bucket: "+t.message);case 4:return[2]}}))}))},e.prototype.HandleList=function(e,t){return o(this,void 0,void 0,(function(){var n,s,i;return u(this,(function(o){switch(o.label){case 0:return o.trys.push([0,4,,5]),[4,te(e,"path")];case 1:return o.sent(),[4,this.getBucket(e.bucketname)];case 2:return n=o.sent(),[4,re.GetList(n,e.path,t,e.isAdmin)];case 3:return s=o.sent(),[2,{result:s}];case 4:throw i=o.sent(),new r.VError(i);case 5:return[2]}}))}))},e.prototype.HandleRename=function(e,t){return o(this,void 0,void 0,(function(){var n,s,i;return u(this,(function(o){switch(o.label){case 0:return o.trys.push([0,5,,6]),[4,te(e,"item")];case 1:return o.sent(),[4,te(e,"newItemPath")];case 2:return o.sent(),[4,this.getBucket(e.bucketname)];case 3:return n=o.sent(),[4,re.RenameFile(n,e.item,e.newItemPath,t)];case 4:return s=o.sent(),[2,{result:s}];case 5:throw i=o.sent(),new r.VError(i);case 6:return[2]}}))}))},e.prototype.HandleMove=function(e,t){return o(this,void 0,void 0,(function(){var n,s,i;return u(this,(function(o){switch(o.label){case 0:return o.trys.push([0,5,,6]),[4,this.getBucket(e.bucketname)];case 1:return n=o.sent(),[4,te(e,"items")];case 2:return o.sent(),[4,te(e,"newPath")];case 3:return o.sent(),[4,re.MoveFiles(n,e.items,e.newPath,t)];case 4:return s=o.sent(),[2,{result:s}];case 5:throw i=o.sent(),new r.VError(i);case 6:return[2]}}))}))},e.prototype.HandleCopy=function(e,t){return o(this,void 0,void 0,(function(){var n,s,i,o;return u(this,(function(u){switch(u.label){case 0:return u.trys.push([0,4,,5]),[4,te(e,"newPath")];case 1:return u.sent(),[4,this.getBucket(e.bucketname)];case 2:if(n=u.sent(),s=void 0,e.items)s=e.items;else{if(!e.singleFileName)throw new Error("Request does not contain either body.items or body.singleFileName");s=[e.singleFileName]}return[4,re.CopyFiles(n,s,e.newPath,t)];case 3:return i=u.sent(),[2,{result:i}];case 4:throw o=u.sent(),new r.VError(o);case 5:return[2]}}))}))},e.prototype.HandleRemove=function(e,t){return o(this,void 0,void 0,(function(){var n,s,i;return u(this,(function(o){switch(o.label){case 0:return o.trys.push([0,4,,5]),[4,te(e,"items")];case 1:return o.sent(),[4,this.getBucket(e.bucketname)];case 2:return n=o.sent(),[4,re.RemoveFiles(n,e.items,t)];case 3:return s=o.sent(),[2,{result:s}];case 4:throw i=o.sent(),new r.VError(i);case 5:return[2]}}))}))},e.prototype.HandleEdit=function(e,t){return o(this,void 0,void 0,(function(){var n,s,i;return u(this,(function(o){switch(o.label){case 0:return o.trys.push([0,5,,6]),[4,te(e,"item")];case 1:return o.sent(),[4,te(e,"content")];case 2:return o.sent(),[4,this.getBucket(e.bucketname)];case 3:return n=o.sent(),[4,re.EditFile(n,e.item,e.content,t)];case 4:return s=o.sent(),[2,{result:s}];case 5:throw i=o.sent(),new r.VError(i);case 6:return[2]}}))}))},e.prototype.HandleGetContent=function(e,t){return o(this,void 0,void 0,(function(){var n,s,i;return u(this,(function(o){switch(o.label){case 0:return o.trys.push([0,4,,5]),[4,te(e,"item")];case 1:return o.sent(),[4,this.getBucket(e.bucketname)];case 2:return n=o.sent(),[4,re.GetFileContent(n,e.item,t)];case 3:return s=o.sent(),[2,{result:s}];case 4:throw i=o.sent(),new r.VError(i);case 5:return[2]}}))}))},e.prototype.HandleGetSingle=function(e,t){return o(this,void 0,void 0,(function(){var n,s,i;return u(this,(function(o){switch(o.label){case 0:return o.trys.push([0,4,,5]),[4,te(e,"item")];case 1:return o.sent(),[4,this.getBucket(e.bucketname)];case 2:return n=o.sent(),[4,re.GetSingle(n,e.item,t)];case 3:return s=o.sent(),[2,{result:{success:!0,file:s,url:s.downloadUrl}}];case 4:throw i=o.sent(),new r.VError(i);case 5:return[2]}}))}))},e.prototype.HandleCreateFolder=function(e,t){return o(this,void 0,void 0,(function(){var n,s,i;return u(this,(function(o){switch(o.label){case 0:return o.trys.push([0,4,,5]),[4,te(e,"newPath")];case 1:return o.sent(),[4,this.getBucket(e.bucketname)];case 2:return n=o.sent(),[4,re.CreateFolder(n,e.newPath,t,e.disableNoClobber,e.isAdmin)];case 3:return s=o.sent(),[2,{result:s}];case 4:throw i=o.sent(),new r.VError(i);case 5:return[2]}}))}))},e.prototype.HandleSetPermissions=function(e,t){return o(this,void 0,void 0,(function(){var n,s,i;return u(this,(function(o){switch(o.label){case 0:return o.trys.push([0,6,,7]),[4,te(e,"items")];case 1:return o.sent(),[4,te(e,"role")];case 2:return o.sent(),[4,te(e,"entity")];case 3:return o.sent(),[4,this.getBucket(e.bucketname)];case 4:return n=o.sent(),[4,re.ChangePermissions(n,e.items,e.role,e.entity,e.recursive,t)];case 5:return s=o.sent(),[2,{result:s}];case 6:throw i=o.sent(),new r.VError(i.message);case 7:return[2]}}))}))},e.prototype.HandleSetPermissionsObject=function(e,t){return o(this,void 0,void 0,(function(){var n,s,i;return u(this,(function(o){switch(o.label){case 0:return o.trys.push([0,5,,6]),[4,te(e,"items")];case 1:return o.sent(),[4,te(e,"permissionsObj")];case 2:return o.sent(),[4,this.getBucket(e.bucketname)];case 3:return n=o.sent(),[4,re.ChangePermissionsObject(n,e.items,e.permissionsObj,e.recursive,t)];case 4:return s=o.sent(),[2,{result:s}];case 5:throw i=o.sent(),new r.VError(i.message);case 6:return[2]}}))}))},e.prototype.HandleSaveFile=function(e,t,n,s,i,a){return o(this,void 0,void 0,(function(){var o,c;return u(this,(function(u){switch(u.label){case 0:return u.trys.push([0,3,,4]),[4,this.getBucket(e)];case 1:return o=u.sent(),[4,re.UploadFile(o,t,n,s,i,a)];case 2:return u.sent(),[2,{result:{success:!0}}];case 3:throw c=u.sent(),new r.VError(c);case 4:return[2]}}))}))},e}();var se,ie=require("express"),oe=!1,ue=ie();ue.use((function(e,r,t){return o(this,void 0,void 0,(function(){var n;return u(this,(function(s){switch(s.label){case 0:r.setHeader("Access-Control-Allow-Headers","Authorization, X-Requested-With, Accept, Content-Type, Origin, Cache-Control, X-File-Name"),r.setHeader("Access-Control-Allow-Origin","*"),s.label=1;case 1:return s.trys.push([1,3,,4]),[4,new Promise((function(t,n){l({origin:!0})(e,r,(function(){t()}))}))];case 2:return s.sent(),t(),[3,4];case 3:throw n=s.sent(),new Error(n.message);case 4:return[2]}}))}))})),ue.use(h),ue.use((function(e,r,t){e.body.path=e.body._c_id+"/"+e.body.path,oe?function(e,r,t){var n=JSON.stringify(e.body||{},null,4).slice(0,500),s="\n---- request: "+e.url+"\nmethod: "+e.method+"\n query: "+JSON.stringify(e.query,null,4)+"\n  body: "+n+"\n----";console.log(s),t()}(e,0,t):t()})),ue.use("/hello",(function(e,r){return o(void 0,void 0,void 0,(function(){return u(this,(function(e){return console.log("HELLO"),r.status(200).send("HELLO\n"),[2]}))}))})),ue.use(f),ue.use("/upload",h,f,v("bucketname"),v("directoryPath"),(function(e,r,t){return o(void 0,void 0,void 0,(function(){var r,n,a,c;return u(this,(function(l){switch(l.label){case 0:return l.trys.push([0,3,,4]),r=new s.IncomingForm,[4,new Promise((function(t,n){r.parse(e,(function(e,r,n){var s=Object.values(n);t(s)}))}))];case 1:return n=l.sent(),[4,Promise.all(n.map((function(e){return function(e){return o(this,void 0,void 0,(function(){var r;return u(this,(function(t){switch(t.label){case 0:return[4,new Promise((function(r,t){return i.readFile(e.path,(function(e,n){e?t(e):r(n)}))}))];case 1:return r=t.sent(),i.unlinkSync(e.path),[2,{buffer:r,mimetype:e.type,originalname:e.name,hash:e.hash}]}}))}))}(e)})))];case 2:return a=l.sent(),e.files=a,t(),[3,4];case 3:throw c=l.sent(),console.error(c),new Error(c);case 4:return[2]}}))}))}),(function(e,t,n){return o(void 0,void 0,void 0,(function(){var n,s,i,a,c,l,h,f;return u(this,(function(d){switch(d.label){case 0:n=e.query.bucketname,s=e.query.directoryPath,d.label=1;case 1:return d.trys.push([1,4,,5]),i=e.files,[4,S.RetrieveCustomClaims(e)];case 2:return a=d.sent(),[4,Promise.all(i.map((function(e){return function(e,r,t,n){return o(this,void 0,void 0,(function(){return u(this,(function(s){return[2,se.HandleSaveFile(e,r,t.originalname,t.mimetype,t.buffer,n)]}))}))}(n,s,e,a)})))];case 3:return c=d.sent(),l={result:{success:!0}},h=c.reduce((function(e,r){return r.result.error?r:l}),l),t.status(200).send(h),[3,5];case 4:return f=d.sent(),console.error("Error occurred while uploading: \n",r.VError.fullStack(f)),t.status(400).send("Error occurred while uploading: \n"+f.message),[2];case 5:return[2]}}))}))})),ue.use("/",d("action"),d("bucketname"),(function(e,t){return o(void 0,void 0,void 0,(function(){var n,s,i,o,a;return u(this,(function(u){switch(u.label){case 0:n=e.body.action,u.label=1;case 1:return u.trys.push([1,27,,28]),[4,S.RetrieveCustomClaims(e)];case 2:switch(s=u.sent(),i=void 0,n){case"list":return[3,3];case"rename":return[3,5];case"move":return[3,7];case"copy":return[3,9];case"remove":return[3,11];case"edit":return[3,13];case"getContent":return[3,15];case"createFolder":return[3,17];case"getSingle":return[3,19];case"changePermissions":return[3,21];case"changePermissionsObject":return[3,23];case"compress":case"extract":case"downloadMultiple":return[3,25]}return[3,25];case 3:return[4,se.HandleList(e.body,s)];case 4:return i=u.sent(),[3,26];case 5:return[4,se.HandleRename(e.body,s)];case 6:return i=u.sent(),[3,26];case 7:return[4,se.HandleMove(e.body,s)];case 8:return i=u.sent(),[3,26];case 9:return[4,se.HandleCopy(e.body,s)];case 10:return i=u.sent(),[3,26];case 11:return[4,se.HandleRemove(e.body,s)];case 12:return i=u.sent(),[3,26];case 13:return[4,se.HandleEdit(e.body,s)];case 14:return i=u.sent(),[3,26];case 15:return[4,se.HandleGetContent(e.body,s)];case 16:return i=u.sent(),[3,26];case 17:return[4,se.HandleCreateFolder(e.body,s)];case 18:return i=u.sent(),[3,26];case 19:return[4,se.HandleGetSingle(e.body,s)];case 20:return i=u.sent(),[3,26];case 21:return[4,se.HandleSetPermissions(e.body,s)];case 22:return i=u.sent(),[3,26];case 23:return[4,se.HandleSetPermissionsObject(e.body,s)];case 24:return i=u.sent(),[3,26];case 25:throw new Error("action has not been implemented");case 26:return t.status(200).send(i),[3,28];case 27:return o=u.sent(),console.error("Error while processing request: \n",r.VError.fullStack(o)),a={error:"Bad request to ngx-file-manager!",errorDetail:o.message,requestBody:e.body},t.status(400).send(a),[3,28];case 28:return[2]}}))}))})),ue.use((function(e,r){return o(this,void 0,void 0,(function(){var t;return u(this,(function(n){return t=JSON.stringify(e.body),r.status(501).send("That request has not been implemented: "+t),[2]}))}))}));e.FileManagerEndpointExpress=function(e){return oe=e.logging,se=new ne(e.storage),ue},Object.defineProperty(e,"__esModule",{value:!0})}));
//# sourceMappingURL=ngx-filemanager-api-firebase.umd.min.js.map