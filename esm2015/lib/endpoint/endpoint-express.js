import { __awaiter } from "tslib";
// Add middle ware to this route
const express = require('express');
import { OptionRequestsAreOk, PostRequestsOnly, HasBodyProp, HasQueryParam, AddCors, LogRequest } from './middleware-helpers';
import { NgxFileMangerApiFireBaseClass } from '../api/firebase-storage-api';
import { VError } from 'verror';
let fmApi;
let LOGGING = false;
const endpoint = express();
endpoint.use(AddCors);
endpoint.use(OptionRequestsAreOk);
endpoint.use((req, res, next) => {
    req.body.path = `${req.body._c_id}/${req.body.path}`;
    if (LOGGING) {
        LogRequest(req, res, next);
    }
    else {
        next();
    }
});
endpoint.use('/hello', (req, res) => __awaiter(void 0, void 0, void 0, function* () {
    console.log('HELLO');
    res.status(200).send('HELLO\n');
}));
endpoint.use(PostRequestsOnly);
import { ParseUploadFile } from './middleware-upload';
import { permsQueries } from '../permissions/permissions-queries';
endpoint.use('/upload', OptionRequestsAreOk, PostRequestsOnly, HasQueryParam('bucketname'), HasQueryParam('directoryPath'), ParseUploadFile, (req, res, next) => __awaiter(void 0, void 0, void 0, function* () {
    const bucketname = req.query.bucketname;
    const directoryPath = req.query.directoryPath;
    try {
        const files = req.files;
        const userClaims = yield permsQueries.RetrieveCustomClaims(req);
        const results = yield Promise.all(files.map(file => trySaveFile(bucketname, directoryPath, file, userClaims)));
        const success = {
            result: {
                success: true
            }
        };
        const finalResult = results.reduce((acc, cur) => {
            if (cur.result.error) {
                return cur;
            }
            return success;
        }, success);
        res.status(200).send(finalResult);
    }
    catch (error) {
        console.error('Error occurred while uploading: \n', VError.fullStack(error));
        res
            .status(400)
            .send('Error occurred while uploading: \n' + error.message);
        return;
    }
}));
function trySaveFile(bucketname, directoryPath, f, userClaims) {
    return __awaiter(this, void 0, void 0, function* () {
        return fmApi.HandleSaveFile(bucketname, directoryPath, f.originalname, f.mimetype, f.buffer, userClaims);
    });
}
endpoint.use('/', HasBodyProp('action'), HasBodyProp('bucketname'), (req, res) => __awaiter(void 0, void 0, void 0, function* () {
    const action = req.body.action;
    try {
        const userClaims = yield permsQueries.RetrieveCustomClaims(req);
        let body;
        switch (action) {
            case 'list':
                body = yield fmApi.HandleList(req.body, userClaims);
                break;
            case 'rename':
                body = yield fmApi.HandleRename(req.body, userClaims);
                break;
            case 'move':
                body = yield fmApi.HandleMove(req.body, userClaims);
                break;
            case 'copy':
                body = yield fmApi.HandleCopy(req.body, userClaims);
                break;
            case 'remove':
                body = yield fmApi.HandleRemove(req.body, userClaims);
                break;
            case 'edit':
                body = yield fmApi.HandleEdit(req.body, userClaims);
                break;
            case 'getContent':
                body = yield fmApi.HandleGetContent(req.body, userClaims);
                break;
            case 'createFolder':
                body = yield fmApi.HandleCreateFolder(req.body, userClaims);
                break;
            case 'getSingle':
                body = yield fmApi.HandleGetSingle(req.body, userClaims);
                break;
            case 'changePermissions':
                body = yield fmApi.HandleSetPermissions(req.body, userClaims);
                break;
            case 'changePermissionsObject':
                body = yield fmApi.HandleSetPermissionsObject(req.body, userClaims);
                break;
            case 'compress':
            case 'extract':
            case 'downloadMultiple':
            default:
                throw new Error('action has not been implemented');
        }
        res.status(200).send(body);
    }
    catch (error) {
        console.error('Error while processing request: \n', VError.fullStack(error));
        const returnedError = {
            error: `Bad request to ngx-file-manager!`,
            errorDetail: error.message,
            requestBody: req.body
        };
        res.status(400).send(returnedError);
    }
}));
endpoint.use(notImplemented);
function notImplemented(req, res) {
    return __awaiter(this, void 0, void 0, function* () {
        const bodyString = JSON.stringify(req.body);
        res.status(501).send('That request has not been implemented: ' + bodyString);
    });
}
/*
Use by attaching to a firebase function
exports.FileManagerApi = StorageEndpoint;
*/
export const FileManagerEndpointExpress = (options) => {
    LOGGING = options.logging;
    fmApi = new NgxFileMangerApiFireBaseClass(options.storage);
    return endpoint;
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZW5kcG9pbnQtZXhwcmVzcy5qcyIsInNvdXJjZVJvb3QiOiIvVm9sdW1lcy9TaGl2YW5nL1BpIFNvZnR3YXJlL2ZpbGUtbWFuYWdlci9uZ3gtZmlsZW1hbmFnZXIvcHJvamVjdHMvbmd4LWZpbGVtYW5hZ2VyLWFwaS1maXJlYmFzZS9zcmMvIiwic291cmNlcyI6WyJsaWIvZW5kcG9pbnQvZW5kcG9pbnQtZXhwcmVzcy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUEsZ0NBQWdDO0FBQ2hDLE1BQU0sT0FBTyxHQUFHLE9BQU8sQ0FBQyxTQUFTLENBQUMsQ0FBQztBQUNuQyxPQUFPLEVBQ0wsbUJBQW1CLEVBQ25CLGdCQUFnQixFQUNoQixXQUFXLEVBQ1gsYUFBYSxFQUNiLE9BQU8sRUFDUCxVQUFVLEVBQ1gsTUFBTSxzQkFBc0IsQ0FBQztBQUU5QixPQUFPLEVBQUUsNkJBQTZCLEVBQUUsTUFBTSw2QkFBNkIsQ0FBQztBQUM1RSxPQUFPLEVBQUUsTUFBTSxFQUFFLE1BQU0sUUFBUSxDQUFDO0FBR2hDLElBQUksS0FBb0MsQ0FBQztBQUN6QyxJQUFJLE9BQU8sR0FBRyxLQUFLLENBQUM7QUFFcEIsTUFBTSxRQUFRLEdBQUcsT0FBTyxFQUFFLENBQUM7QUFDM0IsUUFBUSxDQUFDLEdBQUcsQ0FBQyxPQUFPLENBQUMsQ0FBQztBQUN0QixRQUFRLENBQUMsR0FBRyxDQUFDLG1CQUFtQixDQUFDLENBQUM7QUFDbEMsUUFBUSxDQUFDLEdBQUcsQ0FBQyxDQUFDLEdBQVksRUFBRSxHQUFhLEVBQUUsSUFBa0IsRUFBRSxFQUFFO0lBRS9ELEdBQUcsQ0FBQyxJQUFJLENBQUMsSUFBSSxHQUFHLEdBQUcsR0FBRyxDQUFDLElBQUksQ0FBQyxLQUFLLElBQUksR0FBRyxDQUFDLElBQUksQ0FBQyxJQUFJLEVBQUUsQ0FBQztJQUVyRCxJQUFJLE9BQU8sRUFBRTtRQUNYLFVBQVUsQ0FBQyxHQUFHLEVBQUUsR0FBRyxFQUFFLElBQUksQ0FBQyxDQUFDO0tBQzVCO1NBQU07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QUNGLFFBQVEsQ0FBQyxHQUFHLENBQUMsY0FBYyxDQUFDLENBQUM7QUFFN0IsU0FBZSxjQUFjLENBQUMsR0FBRyxFQUFFLEdBQUc7O1FBQ3BDLE1BQU0sVUFBVSxHQUFHLElBQUksQ0FBQyxTQUFTLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxDQUFDO1FBQzVDLEdBQUcsQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUMsSUFBSSxDQUFDLHlDQUF5QyxHQUFHLFVBQVUsQ0FBQyxDQUFDO0lBQy9FLENBQUM7Q0FBQTtBQU9EOzs7RUFHRTtBQUNGLE1BQU0sQ0FBQyxNQUFNLDBCQUEwQixHQUFHLENBQ3hDLE9BQW1DLEVBQ25DLEVBQUU7SUFDRixPQUFPLEdBQUcsT0FBTyxDQUFDLE9BQU8sQ0FBQztJQUMxQixLQUFLLEdBQUcsSUFBSSw2QkFBNkIsQ0FBQyxPQUFPLENBQUMsT0FBTyxDQUFDLENBQUM7SUFDM0QsT0FBTyxRQUFRLENBQUM7QUFDbEIsQ0FBQyxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiLy8gQWRkIG1pZGRsZSB3YXJlIHRvIHRoaXMgcm91dGVcbmNvbnN0IGV4cHJlc3MgPSByZXF1aXJlKCdleHByZXNzJyk7XG5pbXBvcnQge1xuICBPcHRpb25SZXF1ZXN0c0FyZU9rLFxuICBQb3N0UmVxdWVzdHNPbmx5LFxuICBIYXNCb2R5UHJvcCxcbiAgSGFzUXVlcnlQYXJhbSxcbiAgQWRkQ29ycyxcbiAgTG9nUmVxdWVzdFxufSBmcm9tICcuL21pZGRsZXdhcmUtaGVscGVycyc7XG5pbXBvcnQgeyBTdG9yYWdlIH0gZnJvbSAnLi4vdHlwZXMvZ29vZ2xlLWNsb3VkLXR5cGVzJztcbmltcG9ydCB7IE5neEZpbGVNYW5nZXJBcGlGaXJlQmFzZUNsYXNzIH0gZnJvbSAnLi4vYXBpL2ZpcmViYXNlLXN0b3JhZ2UtYXBpJztcbmltcG9ydCB7IFZFcnJvciB9IGZyb20gJ3ZlcnJvcic7XG5pbXBvcnQgeyBSZXF1ZXN0LCBSZXNwb25zZSwgTmV4dEZ1bmN0aW9uIH0gZnJvbSAnZXhwcmVzcyc7XG5cbmxldCBmbUFwaTogTmd4RmlsZU1hbmdlckFwaUZpcmVCYXNlQ2xhc3M7XG5sZXQgTE9HR0lORyA9IGZhbHNlO1xuXG5jb25zdCBlbmRwb2ludCA9IGV4cHJlc3MoKTtcbmVuZHBvaW50LnVzZShBZGRDb3JzKTtcbmVuZHBvaW50LnVzZShPcHRpb25SZXF1ZXN0c0FyZU9rKTtcbmVuZHBvaW50LnVzZSgocmVxOiBSZXF1ZXN0LCByZXM6IFJlc3BvbnNlLCBuZXh0OiBOZXh0RnVuY3Rpb24pID0+IHtcbiAgXG4gIHJlcS5ib2R5LnBhdGggPSBgJHtyZXEuYm9keS5fY19pZH0vJHtyZXEuYm9keS5wYXRofWA7XG4gIFxuICBpZiAoTE9HR0lORykge1xuICAgIExvZ1JlcXVlc3QocmVxLCByZXMsIG5leHQpO1xuICB9IGVsc2Uge1xuICAgIG5leHQoKTtcbiAgfVxufSk7XG5cbmVuZHBvaW50LnVzZSgnL2hlbGxvJywgYXN5bmMgKHJlcSwgcmVzKSA9PiB7XG4gIGNvbnNvbGUubG9nKCdIRUxMTycpO1xuICByZXMuc3RhdHVzKDIwMCkuc2VuZCgnSEVMTE9cXG4nKTtcbn0pO1xuXG5lbmRwb2ludC51c2UoUG9zdFJlcXVlc3RzT25seSk7XG5cbmltcG9ydCB7IFBhcnNlVXBsb2FkRmlsZSwgVXBsb2FkZWRGaWxlIH0gZnJvbSAnLi9taWRkbGV3YXJlLXVwbG9hZCc7XG5pbXBvcnQgeyBwZXJtc1F1ZXJpZXMgfSBmcm9tICcuLi9wZXJtaXNzaW9ucy9wZXJtaXNzaW9ucy1xdWVyaWVzJztcbmltcG9ydCB7IENvcmVUeXBlcyB9IGZyb20gJy4uL3R5cGVzJztcblxuZW5kcG9pbnQudXNlKFxuICAnL3VwbG9hZCcsXG4gIE9wdGlvblJlcXVlc3RzQXJlT2ssXG4gIFBvc3RSZXF1ZXN0c09ubHksXG4gIEhhc1F1ZXJ5UGFyYW0oJ2J1Y2tldG5hbWUnKSxcbiAgSGFzUXVlcnlQYXJhbSgnZGlyZWN0b3J5UGF0aCcpLFxuICBQYXJzZVVwbG9hZEZpbGUsXG4gIGFzeW5jIChyZXEsIHJlcywgbmV4dCkgPT4ge1xuICAgIGNvbnN0IGJ1Y2tldG5hbWU6IHN0cmluZyA9IHJlcS5xdWVyeS5idWNrZXRuYW1lO1xuICAgIGNvbnN0IGRpcmVjdG9yeVBhdGg6IHN0cmluZyA9IHJlcS5xdWVyeS5kaXJlY3RvcnlQYXRoO1xuICAgIHRyeSB7XG4gICAgICBjb25zdCBmaWxlcyA9IHJlcS5maWxlcyBhcyBVcGxvYWRlZEZpbGVbXTtcbiAgICAgIGNvbnN0IHVzZXJDbGFpbXMgPSBhd2FpdCBwZXJtc1F1ZXJpZXMuUmV0cmlldmVDdXN0b21DbGFpbXMocmVxKTtcbiAgICAgIGNvbnN0IHJlc3VsdHMgPSBhd2FpdCBQcm9taXNlLmFsbChcbiAgICAgICAgZmlsZXMubWFwKGZpbGUgPT5cbiAgICAgICAgICB0cnlTYXZlRmlsZShidWNrZXRuYW1lLCBkaXJlY3RvcnlQYXRoLCBmaWxlLCB1c2VyQ2xhaW1zKVxuICAgICAgICApXG4gICAgICApO1xuICAgICAgY29uc3Qgc3VjY2VzcyA9IHtcbiAgICAgICAgcmVzdWx0OiB7XG4gICAgICAgICAgc3VjY2VzczogdHJ1ZVxuICAgICAgICB9XG4gICAgICB9O1xuICAgICAgY29uc3QgZmluYWxSZXN1bHQgPSByZXN1bHRzLnJlZHVjZSgoYWNjLCBjdXIpID0+IHtcbiAgICAgICAgaWYgKGN1ci5yZXN1bHQuZXJyb3IpIHtcbiAgICAgICAgICByZXR1cm4gY3VyO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiBzdWNjZXNzO1xuICAgICAgfSwgc3VjY2Vzcyk7XG4gICAgICByZXMuc3RhdHVzKDIwMCkuc2VuZChmaW5hbFJlc3VsdCk7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIGNvbnNvbGUuZXJyb3IoXG4gICAgICAgICdFcnJvciBvY2N1cnJlZCB3aGlsZSB1cGxvYWRpbmc6IFxcbicsXG4gICAgICAgIFZFcnJvci5mdWxsU3RhY2soZXJyb3IpXG4gICAgICApO1xuICAgICAgcmVzXG4gICAgICAgIC5zdGF0dXMoNDAwKVxuICAgICAgICAuc2VuZCgnRXJyb3Igb2NjdXJyZWQgd2hpbGUgdXBsb2FkaW5nOiBcXG4nICsgZXJyb3IubWVzc2FnZSk7XG4gICAgICByZXR1cm47XG4gICAgfVxuICB9XG4pO1xuXG5hc3luYyBmdW5jdGlvbiB0cnlTYXZlRmlsZShcbiAgYnVja2V0bmFtZTogc3RyaW5nLFxuICBkaXJlY3RvcnlQYXRoOiBzdHJpbmcsXG4gIGY6IFVwbG9hZGVkRmlsZSxcbiAgdXNlckNsYWltczogQ29yZVR5cGVzLlVzZXJDdXN0b21DbGFpbXNcbikge1xuICByZXR1cm4gZm1BcGkuSGFuZGxlU2F2ZUZpbGUoXG4gICAgYnVja2V0bmFtZSxcbiAgICBkaXJlY3RvcnlQYXRoLFxuICAgIGYub3JpZ2luYWxuYW1lLFxuICAgIGYubWltZXR5cGUsXG4gICAgZi5idWZmZXIsXG4gICAgdXNlckNsYWltc1xuICApO1xufVxuXG5lbmRwb2ludC51c2UoXG4gICcvJyxcbiAgSGFzQm9keVByb3AoJ2FjdGlvbicpLFxuICBIYXNCb2R5UHJvcCgnYnVja2V0bmFtZScpLFxuICBhc3luYyAocmVxLCByZXMpID0+IHtcbiAgICBjb25zdCBhY3Rpb246IENvcmVUeXBlcy5GaWxlTWFuYWdlckFjdGlvbiA9IHJlcS5ib2R5LmFjdGlvbjtcbiAgICB0cnkge1xuICAgICAgY29uc3QgdXNlckNsYWltcyA9IGF3YWl0IHBlcm1zUXVlcmllcy5SZXRyaWV2ZUN1c3RvbUNsYWltcyhyZXEpO1xuICAgICAgbGV0IGJvZHk7XG4gICAgICBzd2l0Y2ggKGFjdGlvbikge1xuICAgICAgICBjYXNlICdsaXN0JzpcbiAgICAgICAgICBib2R5ID0gYXdhaXQgZm1BcGkuSGFuZGxlTGlzdChyZXEuYm9keSwgdXNlckNsYWltcyk7XG4gICAgICAgICAgYnJlYWs7XG4gICAgICAgIGNhc2UgJ3JlbmFtZSc6XG4gICAgICAgICAgYm9keSA9IGF3YWl0IGZtQXBpLkhhbmRsZVJlbmFtZShyZXEuYm9keSwgdXNlckNsYWltcyk7XG4gICAgICAgICAgYnJlYWs7XG4gICAgICAgIGNhc2UgJ21vdmUnOlxuICAgICAgICAgIGJvZHkgPSBhd2FpdCBmbUFwaS5IYW5kbGVNb3ZlKHJlcS5ib2R5LCB1c2VyQ2xhaW1zKTtcbiAgICAgICAgICBicmVhaztcbiAgICAgICAgY2FzZSAnY29weSc6XG4gICAgICAgICAgYm9keSA9IGF3YWl0IGZtQXBpLkhhbmRsZUNvcHkocmVxLmJvZHksIHVzZXJDbGFpbXMpO1xuICAgICAgICAgIGJyZWFrO1xuICAgICAgICBjYXNlICdyZW1vdmUnOlxuICAgICAgICAgIGJvZHkgPSBhd2FpdCBmbUFwaS5IYW5kbGVSZW1vdmUocmVxLmJvZHksIHVzZXJDbGFpbXMpO1xuICAgICAgICAgIGJyZWFrO1xuICAgICAgICBjYXNlICdlZGl0JzpcbiAgICAgICAgICBib2R5ID0gYXdhaXQgZm1BcGkuSGFuZGxlRWRpdChyZXEuYm9keSwgdXNlckNsYWltcyk7XG4gICAgICAgICAgYnJlYWs7XG4gICAgICAgIGNhc2UgJ2dldENvbnRlbnQnOlxuICAgICAgICAgIGJvZHkgPSBhd2FpdCBmbUFwaS5IYW5kbGVHZXRDb250ZW50KHJlcS5ib2R5LCB1c2VyQ2xhaW1zKTtcbiAgICAgICAgICBicmVhaztcbiAgICAgICAgY2FzZSAnY3JlYXRlRm9sZGVyJzpcbiAgICAgICAgICBib2R5ID0gYXdhaXQgZm1BcGkuSGFuZGxlQ3JlYXRlRm9sZGVyKHJlcS5ib2R5LCB1c2VyQ2xhaW1zKTtcbiAgICAgICAgICBicmVhaztcbiAgICAgICAgY2FzZSAnZ2V0U2luZ2xlJzpcbiAgICAgICAgICBib2R5ID0gYXdhaXQgZm1BcGkuSGFuZGxlR2V0U2luZ2xlKHJlcS5ib2R5LCB1c2VyQ2xhaW1zKTtcbiAgICAgICAgICBicmVhaztcbiAgICAgICAgY2FzZSAnY2hhbmdlUGVybWlzc2lvbnMnOlxuICAgICAgICAgIGJvZHkgPSBhd2FpdCBmbUFwaS5IYW5kbGVTZXRQZXJtaXNzaW9ucyhyZXEuYm9keSwgdXNlckNsYWltcyk7XG4gICAgICAgICAgYnJlYWs7XG4gICAgICAgIGNhc2UgJ2NoYW5nZVBlcm1pc3Npb25zT2JqZWN0JzpcbiAgICAgICAgICBib2R5ID0gYXdhaXQgZm1BcGkuSGFuZGxlU2V0UGVybWlzc2lvbnNPYmplY3QocmVxLmJvZHksIHVzZXJDbGFpbXMpO1xuICAgICAgICAgIGJyZWFrO1xuICAgICAgICBjYXNlICdjb21wcmVzcyc6XG4gICAgICAgIGNhc2UgJ2V4dHJhY3QnOlxuICAgICAgICBjYXNlICdkb3dubG9hZE11bHRpcGxlJzpcbiAgICAgICAgZGVmYXVsdDpcbiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ2FjdGlvbiBoYXMgbm90IGJlZW4gaW1wbGVtZW50ZWQnKTtcbiAgICAgIH1cbiAgICAgIHJlcy5zdGF0dXMoMjAwKS5zZW5kKGJvZHkpO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICBjb25zb2xlLmVycm9yKFxuICAgICAgICAnRXJyb3Igd2hpbGUgcHJvY2Vzc2luZyByZXF1ZXN0OiBcXG4nLFxuICAgICAgICBWRXJyb3IuZnVsbFN0YWNrKGVycm9yKVxuICAgICAgKTtcbiAgICAgIGNvbnN0IHJldHVybmVkRXJyb3IgPSB7XG4gICAgICAgIGVycm9yOiBgQmFkIHJlcXVlc3QgdG8gbmd4LWZpbGUtbWFuYWdlciFgLFxuICAgICAgICBlcnJvckRldGFpbDogZXJyb3IubWVzc2FnZSxcbiAgICAgICAgcmVxdWVzdEJvZHk6IHJlcS5ib2R5XG4gICAgICB9O1xuICAgICAgcmVzLnN0YXR1cyg0MDApLnNlbmQocmV0dXJuZWRFcnJvcik7XG4gICAgfVxuICB9XG4pO1xuZW5kcG9pbnQudXNlKG5vdEltcGxlbWVudGVkKTtcblxuYXN5bmMgZnVuY3Rpb24gbm90SW1wbGVtZW50ZWQocmVxLCByZXMpIHtcbiAgY29uc3QgYm9keVN0cmluZyA9IEpTT04uc3RyaW5naWZ5KHJlcS5ib2R5KTtcbiAgcmVzLnN0YXR1cyg1MDEpLnNlbmQoJ1RoYXQgcmVxdWVzdCBoYXMgbm90IGJlZW4gaW1wbGVtZW50ZWQ6ICcgKyBib2R5U3RyaW5nKTtcbn1cblxuZXhwb3J0IGludGVyZmFjZSBGaWxlTWFuYWdlckVuZHBvaW50T3B0aW9ucyB7XG4gIGxvZ2dpbmc/OiBib29sZWFuO1xuICBzdG9yYWdlOiBTdG9yYWdlO1xufVxuXG4vKlxuVXNlIGJ5IGF0dGFjaGluZyB0byBhIGZpcmViYXNlIGZ1bmN0aW9uXG5leHBvcnRzLkZpbGVNYW5hZ2VyQXBpID0gU3RvcmFnZUVuZHBvaW50O1xuKi9cbmV4cG9ydCBjb25zdCBGaWxlTWFuYWdlckVuZHBvaW50RXhwcmVzcyA9IChcbiAgb3B0aW9uczogRmlsZU1hbmFnZXJFbmRwb2ludE9wdGlvbnNcbikgPT4ge1xuICBMT0dHSU5HID0gb3B0aW9ucy5sb2dnaW5nO1xuICBmbUFwaSA9IG5ldyBOZ3hGaWxlTWFuZ2VyQXBpRmlyZUJhc2VDbGFzcyhvcHRpb25zLnN0b3JhZ2UpO1xuICByZXR1cm4gZW5kcG9pbnQ7XG59O1xuIl19