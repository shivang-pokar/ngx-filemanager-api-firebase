import { __awaiter } from "tslib";
import * as path from 'path';
import { VError } from 'verror';
import { perms } from '../permissions';
import { paths } from './paths';
export function translateRawStorage(storageObject) {
    const filePath = storageObject.name;
    const filePathParsed = paths.EnsurePrefixSlash(filePath);
    return {
        ref: storageObject,
        name: path.basename(filePathParsed),
        fullPath: filePathParsed,
        isDir: paths.HasTrailingSlash(filePathParsed)
    };
}
export function makePhantomStorageFolder(folderPath) {
    const pathParsed = paths.EnsureAbsolutePathDir(folderPath);
    return {
        ref: null,
        name: path.basename(pathParsed),
        fullPath: pathParsed,
        isDir: true,
        isPhantomFolder: true
    };
}
export function translateStorageToResFile(f) {
    return __awaiter(this, void 0, void 0, function* () {
        const resFile = {};
        resFile.name = f.name;
        if (f.isDir) {
            resFile.type = 'dir';
            resFile.fullPath = paths.EnsureAbsolutePathDir(f.fullPath);
        }
        else {
            resFile.type = 'file';
            resFile.fullPath = paths.EnsureAbsolutePathFile(f.fullPath);
        }
        if (f.isPhantomFolder) {
            resFile.permissions = perms.factory.blankPermissionsObj();
            resFile.isPhantomFolder = true;
            return resFile;
        }
        try {
            const [exists] = yield f.ref.exists();
            if (!exists) {
                throw new Error('File not found: ' + resFile.fullPath);
            }
            const [aclObj] = yield f.ref.acl.get();
            resFile.rightsFirebase = aclObj;
            const metaResp = yield f.ref.getMetadata();
            const metaData = metaResp[0];
            const customMeta = metaData.metadata || {};
            const permissions = yield perms.queries.RetrieveFilePermissions(f.ref);
            resFile.permissions = permissions;
            resFile.size = metaData.size;
            resFile.date = metaData.updated;
            resFile.metaData = customMeta;
            return resFile;
        }
        catch (error) {
            throw new VError(error);
        }
    });
}
export function StreamToPromise(stream) {
    return __awaiter(this, void 0, void 0, function* () {
        return new Promise((resolve, reject) => {
            let stringRes;
            stream.on('readable', function (buffer) {
                const part = buffer.read().toString();
                stringRes += part;
                console.log('stream data ' + part);
            });
            stream.on('end', res => {
                resolve(stringRes);
            });
            stream.on('error', err => {
                const errmsg = 'StreamToPromise(stream: Readable), Error reading stream: ' +
                    err.message;
                console.error(errmsg, { err });
                reject(errmsg);
            });
        });
    });
}
export function getResult(res) {
    const fail = res.statusCode !== 204;
    return {
        success: !fail,
        error: fail ? 'error: ' + res.body : null
    };
}
export function getResultFromArray(res) {
    const fail = res.find(r => r.statusCode !== 204);
    return {
        success: !fail,
        error: fail ? 'error: ' + JSON.stringify(fail.body) : null
    };
}
export function ResultsObjFromArray(moveResults) {
    return moveResults.reduce((acc, cur) => {
        if (cur.error) {
            acc.error += ' | ' + cur.error;
            acc.success = false;
        }
        return acc;
    }, { error: '', success: true });
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidHJhbnNsYXRpb24taGVscGVycy5qcyIsInNvdXJjZVJvb3QiOiIvVm9sdW1lcy9TaGl2YW5nL1BpIFNvZnR3YXJlL2ZpbGUtbWFuYWdlci9uZ3gtZmlsZW1hbmFnZXIvcHJvamVjdHMvbmd4LWZpbGVtYW5hZ2VyLWFwaS1maXJlYmFzZS9zcmMvIiwic291cmNlcyI6WyJsaWIvdXRpbHMvdHJhbnNsYXRpb24taGVscGVycy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBR0EsT0FBTyxLQUFLLElBQUksTUFBTSxNQUFNLENBQUM7QUFDN0IsT0FBTyxFQUFFLE1BQU0sRUFBRSxNQUFNLFFBQVEsQ0FBQztBQUNoQyxPQUFPLEVBQUUsS0FBSyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFDdkMsT0FBTyxFQUFFLEtBQUssRUFBRSxNQUFNLFNBQVMsQ0FBQztBQUdoQyxNQUFNLFVBQVUsbUJBQW1CLENBQUMsYUFBbUI7SUFDckQsTUFBTSxRQUFRLEdBQUcsYUFBYSxDQUFDLElBQUksQ0FBQztJQUNwQyxNQUFNLGNBQWMsR0FBRyxLQUFLLENBQUMsaUJBQWlCLENBQUMsUUFBUSxDQUFDLENBQUM7SUFDekQsT0FBTztRQUNMLEdBQUcsRUFBRSxhQUFhO1FBQ2xCLElBQUksRUFBRSxJQUFJLENBQUMsUUFBUSxDQUFDLGNBQWMsQ0FBQztRQUNuQyxRQUFRLEVBQUUsY0FBYztRQUN4QixLQUFLLEVBQUUsS0FBSyxDQUFDLGdCQUFnQixDQUFDLGNBQWMsQ0FBQztLQUM5QyxDQUFDO0FBQ0osQ0FBQztBQUVELE1BQU0sVUFBVSx3QkFBd0IsQ0FBQyxVQUFrQjtJQUN6RCxNQUFNLFVBQVUsR0FBRyxLQUFLLENBQUMscUJBQXFCLENBQUMsVUFBVSxDQUFDLENBQUM7SUFDM0QsT0FBTztRQUNMLEdBQUcsRUFBRSxJQUFJO1FBQ1QsSUFBSSxFQUFFLElBQUksQ0FBQyxRQUFRLENBQUMsVUFBVSxDQUFDO1FBQy9CLFFBQVEsRUFBRSxVQUFVO1FBQ3BCLEtBQUssRUFBRSxJQUFJ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QUFHLENBQUMsS0FBSyxJQUFJLEtBQUssR0FBRyxHQUFHLENBQUMsS0FBSyxDQUFDO1lBQy9CLEdBQUcsQ0FBQyxPQUFPLEdBQUcsS0FBSyxDQUFDO1NBQ3JCO1FBQ0QsT0FBTyxHQUFHLENBQUM7SUFDYixDQUFDLEVBQ0QsRUFBRSxLQUFLLEVBQUUsRUFBRSxFQUFFLE9BQU8sRUFBRSxJQUFJLEVBQUUsQ0FDN0IsQ0FBQztBQUNKLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBGaWxlRnJvbVN0b3JhZ2UsIEZpbGUgfSBmcm9tICcuLi90eXBlcy9nb29nbGUtY2xvdWQtdHlwZXMnO1xuaW1wb3J0IHsgUmVhZGFibGUgfSBmcm9tICdzdHJlYW0nO1xuaW1wb3J0ICogYXMgcmVxdWVzdCBmcm9tICdyZXF1ZXN0JztcbmltcG9ydCAqIGFzIHBhdGggZnJvbSAncGF0aCc7XG5pbXBvcnQgeyBWRXJyb3IgfSBmcm9tICd2ZXJyb3InO1xuaW1wb3J0IHsgcGVybXMgfSBmcm9tICcuLi9wZXJtaXNzaW9ucyc7XG5pbXBvcnQgeyBwYXRocyB9IGZyb20gJy4vcGF0aHMnO1xuaW1wb3J0IHsgQ29yZVR5cGVzIH0gZnJvbSAnLi4vdHlwZXMnO1xuXG5leHBvcnQgZnVuY3Rpb24gdHJhbnNsYXRlUmF3U3RvcmFnZShzdG9yYWdlT2JqZWN0OiBGaWxlKTogRmlsZUZyb21TdG9yYWdlIHtcbiAgY29uc3QgZmlsZVBhdGggPSBzdG9yYWdlT2JqZWN0Lm5hbWU7XG4gIGNvbnN0IGZpbGVQYXRoUGFyc2VkID0gcGF0aHMuRW5zdXJlUHJlZml4U2xhc2goZmlsZVBhdGgpO1xuICByZXR1cm4ge1xuICAgIHJlZjogc3RvcmFnZU9iamVjdCxcbiAgICBuYW1lOiBwYXRoLmJhc2VuYW1lKGZpbGVQYXRoUGFyc2VkKSxcbiAgICBmdWxsUGF0aDogZmlsZVBhdGhQYXJzZWQsXG4gICAgaXNEaXI6IHBhdGhzLkhhc1RyYWlsaW5nU2xhc2goZmlsZVBhdGhQYXJzZWQpXG4gIH07XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBtYWtlUGhhbnRvbVN0b3JhZ2VGb2xkZXIoZm9sZGVyUGF0aDogc3RyaW5nKTogRmlsZUZyb21TdG9yYWdlIHtcbiAgY29uc3QgcGF0aFBhcnNlZCA9IHBhdGhzLkVuc3VyZUFic29sdXRlUGF0aERpcihmb2xkZXJQYXRoKTtcbiAgcmV0dXJuIHtcbiAgICByZWY6IG51bGwsXG4gICAgbmFtZTogcGF0aC5iYXNlbmFtZShwYXRoUGFyc2VkKSxcbiAgICBmdWxsUGF0aDogcGF0aFBhcnNlZCxcbiAgICBpc0RpcjogdHJ1ZSxcbiAgICBpc1BoYW50b21Gb2xkZXI6IHRydWVcbiAgfTtcbn1cblxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIHRyYW5zbGF0ZVN0b3JhZ2VUb1Jlc0ZpbGUoXG4gIGY6IEZpbGVGcm9tU3RvcmFnZVxuKTogUHJvbWlzZTxDb3JlVHlwZXMuUmVzRmlsZT4ge1xuICBjb25zdCByZXNGaWxlOiBDb3JlVHlwZXMuUmVzRmlsZSA9IHt9IGFzIGFueTtcbiAgcmVzRmlsZS5uYW1lID0gZi5uYW1lO1xuICBpZiAoZi5pc0Rpcikge1xuICAgIHJlc0ZpbGUudHlwZSA9ICdkaXInO1xuICAgIHJlc0ZpbGUuZnVsbFBhdGggPSBwYXRocy5FbnN1cmVBYnNvbHV0ZVBhdGhEaXIoZi5mdWxsUGF0aCk7XG4gIH0gZWxzZSB7XG4gICAgcmVzRmlsZS50eXBlID0gJ2ZpbGUnO1xuICAgIHJlc0ZpbGUuZnVsbFBhdGggPSBwYXRocy5FbnN1cmVBYnNvbHV0ZVBhdGhGaWxlKGYuZnVsbFBhdGgpO1xuICB9XG4gIGlmIChmLmlzUGhhbnRvbUZvbGRlcikge1xuICAgIHJlc0ZpbGUucGVybWlzc2lvbnMgPSBwZXJtcy5mYWN0b3J5LmJsYW5rUGVybWlzc2lvbnNPYmooKTtcbiAgICByZXNGaWxlLmlzUGhhbnRvbUZvbGRlciA9IHRydWU7XG4gICAgcmV0dXJuIHJlc0ZpbGU7XG4gIH1cbiAgdHJ5IHtcbiAgICBjb25zdCBbZXhpc3RzXSA9IGF3YWl0IGYucmVmLmV4aXN0cygpO1xuICAgIGlmICghZXhpc3RzKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ0ZpbGUgbm90IGZvdW5kOiAnICsgcmVzRmlsZS5mdWxsUGF0aCk7XG4gICAgfVxuICAgIGNvbnN0IFthY2xPYmpdID0gYXdhaXQgZi5yZWYuYWNsLmdldCgpO1xuICAgIHJlc0ZpbGUucmlnaHRzRmlyZWJhc2UgPSBhY2xPYmogYXMgYW55O1xuICAgIGNvbnN0IG1ldGFSZXNwID0gYXdhaXQgZi5yZWYuZ2V0TWV0YWRhdGEoKTtcbiAgICBjb25zdCBtZXRhRGF0YSA9IG1ldGFSZXNwWzBdO1xuICAgIGNvbnN0IGN1c3RvbU1ldGEgPSBtZXRhRGF0YS5tZXRhZGF0YSB8fCB7fTtcbiAgICBjb25zdCBwZXJtaXNzaW9ucyA9IGF3YWl0IHBlcm1zLnF1ZXJpZXMuUmV0cmlldmVGaWxlUGVybWlzc2lvbnMoZi5yZWYpO1xuICAgIHJlc0ZpbGUucGVybWlzc2lvbnMgPSBwZXJtaXNzaW9ucztcbiAgICByZXNGaWxlLnNpemUgPSBtZXRhRGF0YS5zaXplO1xuICAgIHJlc0ZpbGUuZGF0ZSA9IG1ldGFEYXRhLnVwZGF0ZWQ7XG4gICAgcmVzRmlsZS5tZXRhRGF0YSA9IGN1c3RvbU1ldGE7XG4gICAgcmV0dXJuIHJlc0ZpbGU7XG4gIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgdGhyb3cgbmV3IFZFcnJvcihlcnJvcik7XG4gIH1cbn1cblxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIFN0cmVhbVRvUHJvbWlzZShzdHJlYW06IFJlYWRhYmxlKTogUHJvbWlzZTxzdHJpbmc+IHtcbiAgcmV0dXJuIG5ldyBQcm9taXNlPHN0cmluZz4oKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgIGxldCBzdHJpbmdSZXM6IHN0cmluZztcbiAgICBzdHJlYW0ub24oJ3JlYWRhYmxlJywgZnVuY3Rpb24oYnVmZmVyKSB7XG4gICAgICBjb25zdCBwYXJ0OiBzdHJpbmcgPSBidWZmZXIucmVhZCgpLnRvU3RyaW5nKCkgYXMgc3RyaW5nO1xuICAgICAgc3RyaW5nUmVzICs9IHBhcnQ7XG4gICAgICBjb25zb2xlLmxvZygnc3RyZWFtIGRhdGEgJyArIHBhcnQpO1xuICAgIH0pO1xuICAgIHN0cmVhbS5vbignZW5kJywgcmVzID0+IHtcbiAgICAgIHJlc29sdmUoc3RyaW5nUmVzKTtcbiAgICB9KTtcbiAgICBzdHJlYW0ub24oJ2Vycm9yJywgZXJyID0+IHtcbiAgICAgIGNvbnN0IGVycm1zZyA9XG4gICAgICAgICdTdHJlYW1Ub1Byb21pc2Uoc3RyZWFtOiBSZWFkYWJsZSksIEVycm9yIHJlYWRpbmcgc3RyZWFtOiAnICtcbiAgICAgICAgZXJyLm1lc3NhZ2U7XG4gICAgICBjb25zb2xlLmVycm9yKGVycm1zZywgeyBlcnIgfSk7XG4gICAgICByZWplY3QoZXJybXNnKTtcbiAgICB9KTtcbiAgfSk7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBnZXRSZXN1bHQocmVzOiByZXF1ZXN0LlJlc3BvbnNlKTogQ29yZVR5cGVzLlJlc3VsdE9iaiB7XG4gIGNvbnN0IGZhaWwgPSByZXMuc3RhdHVzQ29kZSAhPT0gMjA0O1xuICByZXR1cm4ge1xuICAgIHN1Y2Nlc3M6ICFmYWlsLFxuICAgIGVycm9yOiBmYWlsID8gJ2Vycm9yOiAnICsgcmVzLmJvZHkgOiBudWxsXG4gIH07XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBnZXRSZXN1bHRGcm9tQXJyYXkoXG4gIHJlczogcmVxdWVzdC5SZXNwb25zZVtdXG4pOiBDb3JlVHlwZXMuUmVzdWx0T2JqIHtcbiAgY29uc3QgZmFpbCA9IHJlcy5maW5kKHIgPT4gci5zdGF0dXNDb2RlICE9PSAyMDQpO1xuICByZXR1cm4ge1xuICAgIHN1Y2Nlc3M6ICFmYWlsLFxuICAgIGVycm9yOiBmYWlsID8gJ2Vycm9yOiAnICsgSlNPTi5zdHJpbmdpZnkoZmFpbC5ib2R5KSA6IG51bGxcbiAgfTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIFJlc3VsdHNPYmpGcm9tQXJyYXkoXG4gIG1vdmVSZXN1bHRzOiBDb3JlVHlwZXMuUmVzdWx0T2JqW11cbik6IENvcmVUeXBlcy5SZXN1bHRPYmoge1xuICByZXR1cm4gbW92ZVJlc3VsdHMucmVkdWNlKFxuICAgIChhY2MsIGN1cikgPT4ge1xuICAgICAgaWYgKGN1ci5lcnJvcikge1xuICAgICAgICBhY2MuZXJyb3IgKz0gJyB8ICcgKyBjdXIuZXJyb3I7XG4gICAgICAgIGFjYy5zdWNjZXNzID0gZmFsc2U7XG4gICAgICB9XG4gICAgICByZXR1cm4gYWNjO1xuICAgIH0sXG4gICAgeyBlcnJvcjogJycsIHN1Y2Nlc3M6IHRydWUgfVxuICApO1xufVxuIl19